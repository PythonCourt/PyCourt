#!/bin/bash

# ==============================================================================
# ğŸ—¡ï¸ ç‰¹æˆ˜åŒ•é¦– V1.0 - æ·¬ç«é‡é“¸
# å®šä½ï¼šå¯¹å•ä¸€æ–‡ä»¶è¿›è¡Œå®¡è®¡
# ç”¨æ³•: ./qaf.sh <path/to/file.py>
# åœºæ™¯ï¼šæ–°å»ºæˆ–é‡æ„åç«‹å³è¿›è¡Œå•æ–‡ä»¶å®¡è®¡ï¼Œå°†é—®é¢˜æ‰¼æ€åœ¨æ‘‡ç¯®ä¸­
# è¦æ±‚ï¼šå¿…é¡»ç¡®ä¿è¯¥æ–‡ä»¶æ‰€æœ‰æŠ¥é”™æ¸…é›¶ï¼Œå°½ç®¡å½“å‰ä»»åŠ¡ä¸­ä¸åŒ…å«ä¿®å¤è¿™äº›æŠ¥é”™ã€‚
# è¯´æ˜ï¼šæ­¤è„šé€‚ç”¨äºå¤§å¤šæ•°å¸¸è§åœºæ™¯ï¼Œå¯æ ¹æ®å®é™…éœ€è¦è‡ªç”±æ­é…ã€ä¿®æ”¹å’Œæ‰©å±•ã€‚
# ==============================================================================

# =======================================================================
# å‡†å¤‡å¼€å§‹ï¼šç¯å¢ƒé…ç½®
# =======================================================================

# ---------------------------------------------------
# --- 1. é€šç”¨è¾“å‡ºå‡½æ•° ---
# ---------------------------------------------------
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'

print_chapter_header() {
    echo -e "\n${BLUE}================== $1 ==================${NC}"
}

print_sub_header() {
    echo -e "\n${YELLOW}--- $1 ---${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ---------------------------------------------------
# --- 2. å®¡åˆ¤è¯­è¨€é»˜è®¤ä¸ºä¸­æ–‡ï¼Œå¯é€‰ -en ---
# ---------------------------------------------------
export PYCOURT_LANG="${PYCOURT_LANG:-zh}"

# ---------------------------------------------------
# --- 3. é›¶å®¹å¿ï¼Œå‘ç°é—®é¢˜ç«‹å³ç»ˆæ­¢ ---
# ---------------------------------------------------
set -euo pipefail

# ---------------------------------------------------
# --- 4. ä»¥å½“å‰ä½ç½®ä¸ºä¸­å¿ƒï¼ˆæ”¾åœ¨æ ¹ç›®å½•ï¼‰ ---
# ---------------------------------------------------
export PYTHONPATH=$(pwd)

# ---------------------------------------------------
# --- 5. pycourt file å‘½ä»¤å°è£…ä¸å‚æ•°æ£€æŸ¥ ---
# ---------------------------------------------------
validate_target() {
    # æä¾›çš„æ–‡ä»¶è·¯å¾„æ•°é‡é™å®šä¸ºä¸€ä¸ª
    if [ "$#" -lt 1 ]; then
        echo "âŒ é”™è¯¯ï¼šå¿…é¡»æä¾›ä¸€ä¸ªæ–‡ä»¶ä¸ºå®¡åˆ¤ç›®æ ‡ (æ–‡ä»¶è·¯å¾„)" >&2
        echo "ç”¨æ³•: ./qaf.sh <path/to/file.py>" >&2
        exit 1
    fi

    local target="$1"
    # ç›®æ ‡æ–‡ä»¶å¿…é¡»å­˜åœ¨
    if [ ! -f "$target" ]; then
        echo "âŒ é”™è¯¯ï¼šç‰¹æˆ˜åŒ•é¦–çš„å®¡åˆ¤ç›®æ ‡å¿…é¡»æ˜¯ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ã€‚" >&2
        echo "ç”¨æ³•: ./qaf.sh <path/to/file.py>" >&2
        exit 1
    fi

    # ç›®æ ‡å¿…é¡»ä¸º Python æºæ–‡ä»¶
    if [[ "$target" != *.py ]]; then
        echo "âŒ é”™è¯¯ï¼šç‰¹æˆ˜åŒ•é¦–ä»…æ”¯æŒå®¡è®¡å•ä¸ª Python æºæ–‡ä»¶ (*.py)ã€‚" >&2
        echo "ç”¨æ³•: ./qaf.sh <path/to/file.py>" >&2
        exit 1
    fi
}

# è°ƒç”¨æ ¡éªŒå‡½æ•°å¹¶è®¾ç½® AUDIT_TARGET
validate_target "$@"
AUDIT_TARGET="$1"

# pycourtç»Ÿä¸€å®¡è®¡å…¥å£ï¼Œæ ¹æ®æ³•åº­ä»£ç æ‰§è¡Œå¯¹åº”å®¡è®¡
run_judges() {
    local codes="$1"
    poetry run pycourt file "$AUDIT_TARGET" --select "$codes"
}

# ---------------------------------------------------
# --- 6. å¤–éƒ¨å·¥å…·å°è£…ä¸å¯ç”¨æ€§æ£€æŸ¥---
# é¢„ç•™å‚æ•°ç»Ÿä¸€é…ç½®ï¼Œåªå°è£…ï¼Œå…·ä½“å‚æ•°é€šè¿‡ pyproject.toml å†³å®š
# ---------------------------------------------------
run_mypy() {

    poetry run mypy "$@"
}

run_pyright() {
    poetry run pyright "$@"
}

run_bandit() {
    poetry run bandit "$@"
}

run_ruff_check() {
    poetry run ruff check "$@"
}

run_ruff_format() {
    poetry run ruff format "$@"
}

# æŠ¥å‘Šç¼ºå°‘çš„å¤–éƒ¨å·¥å…·
check_tool() {
    local cmd="$1"
    local desc="$2"
    if ! poetry run "$cmd" --version >/dev/null 2>&1; then
        print_warning "ç¼ºå°‘å¤–éƒ¨å·¥å…·: $cmd ($desc)ï¼Œå°†è·³è¿‡å¯¹åº”å®¡è®¡æ­¥éª¤ã€‚"
        return 1
    fi
    return 0
}

# ---------------------------------------------------
# --- å‡†å¤‡å°±ç»ª ---
# ---------------------------------------------------
print_chapter_header "ğŸ—¡ï¸ ç‰¹æˆ˜åŒ•é¦– - å‡†å¤‡å°±ç»ª"
print_sub_header "å®¡è®¡ç›®æ ‡: $AUDIT_TARGET"

# =======================================================================
# ç¬¬ä¸€ç« ï¼šæ¶æ„ç”Ÿæ­»çº¿
# å®¡åˆ¤æœ€æ ¹æœ¬çš„ã€åŠ¨æ‘‡é¡¹ç›®æ ¹åŸºçš„â€œå›å›½ç½ªâ€ã€‚
# =======================================================================
print_chapter_header "ç¬¬ä¸€ç« ï¼šæ¶æ„ç”Ÿæ­»çº¿"

# ---------------------------------------------------
# 1.1 æ¶æ„ä½ç½®ï¼šå¾ªç¯ä¾èµ– / é—¨é¢è§„èŒƒ / ä¾èµ–å€’ç½®
# å…ˆç¡®ä¿æ–‡ä»¶ç«™åœ¨æ­£ç¡®çš„æ¶æ„ä¸–ç•Œï¼Œå¦åˆ™åç»­æ‰€æœ‰ç»“æœéƒ½å¤±å»æ„ä¹‰ã€‚
# ---------------------------------------------------

# ç¦æ­¢ä½¿ç”¨TYPE_CHECKINGç­‰æ‰‹æ®µå¼•å…¥å¾ªç¯ä¾èµ–
print_sub_header "1.1.1 å¾ªç¯ä¾èµ–æ³•åº­ (TC001)"
run_judges "TC001"

# ç¦æ­¢åœ¨é—¨é¢å±‚ä½¿ç”¨é¢†åŸŸé€»è¾‘å¹¶èšåˆå¯¼å‡º
print_sub_header "1.1.2 é—¨é¢çºªå¾‹æ³•åº­ (RE001)"
run_judges "RE001,RE002,RE003"

# ç¦æ­¢è¿åä¾èµ–å€’ç½®åŸåˆ™ç›´æ¥ä¾èµ–å…·ä½“å®ç°
print_sub_header "1.1.3 ä¾èµ–å€’ç½®æ³•åº­ (DI001)"
run_judges "DI001"

# ---------------------------------------------------
# 1.2 äº‹åŠ¡ä¸è¾¹ç•Œï¼šUoW / è¾¹ç•Œ DTO / å‘é‡è§¦å‘åè®®
# åœ¨æ¶æ„ä½ç½®æ­£ç¡®çš„å‰æä¸‹ï¼Œä¼˜å…ˆä¿è¯äº‹åŠ¡è¯­ä¹‰ä¸è¾¹ç•Œå¥‘çº¦çš„æ­£ç¡®ã€‚
# ---------------------------------------------------

# ç¦æ­¢è¿å unit of work åŸåˆ™çš„äº‹åŠ¡å¤„ç†
print_sub_header "1.2.1 ä»“åº“äº‹åŠ¡æ³•åº­ (UW001)"
run_judges "UW001,UW002,UW003,UW004"

# ç¦æ­¢è¿åè¾¹ç•Œ DTO è§„èŒƒçš„è·¨å±‚æ•°æ®ä¼ é€’
print_sub_header "1.2.2 ç–†åŸŸè¾¹ç•Œæ³•åº­ (BC001)"
run_judges "BC001"

# ç¦æ­¢è¿åå‘é‡è§¦å‘åè®®çš„äº‹ä»¶å¤„ç†
print_sub_header "1.2.3 å‘é‡è§¦å‘æ³•åº­ (VT001)"
run_judges "VT001"

# ---------------------------------------------------
# 1.3 ç±»å‹ä¸é¢†åŸŸçºªå¾‹ï¼šAny/dict/cast/object æ»¥ç”¨
# åœ¨â€œåšå¯¹äº‹ã€ç«™å¯¹å±‚â€çš„å‰æä¸‹ï¼Œæ”¶ç´§ç±»å‹ä¸é¢†åŸŸä½¿ç”¨ä¹ æƒ¯ï¼Œé˜²æ­¢ç°è‰²åœ°å¸¦ã€‚
# ---------------------------------------------------

# ç¦æ­¢æ»¥ç”¨é¸­å­ç±»å‹ã€Anyã€cast ç­‰ç ´åç±»å‹çº¯å‡€åº¦çš„è¡Œä¸º
print_sub_header "1.3.1 é¸­å­ç±»å‹æ³•åº­ (AC001)"
run_judges "AC001,AC002,AC003"

# ç¦æ­¢æ»¥ç”¨é€šç”¨å¯¹è±¡ç±»å‹ï¼ˆobjectï¼‰ç ´åé¢†åŸŸçº¯å‡€åº¦çš„è¡Œä¸º
print_sub_header "1.3.2 é¸­å­ç±»å‹æ³•åº­ (OU001)"
run_judges "OU001"

# ç¦æ­¢æ»¥ç”¨æ—¶é—´ç›¸å…³æ“ä½œç ´åé¢†åŸŸçº¯å‡€åº¦çš„è¡Œä¸º
print_sub_header "1.3.3 æ—¶é—´æ¼‚ç§»æ³•åº­ (DT001)"
run_judges "DT001"

# ç¦æ­¢è¿åæŠ€èƒ½é…ç½®è§„èŒƒçš„è¡Œä¸º
print_sub_header "1.3.4 æŠ€èƒ½é…ç½®æ³•åº­ (SK001)"
run_judges "SK001"

# =======================================================================
# ç¬¬äºŒç« ï¼šç±»å‹è”é‚¦è°ƒæŸ¥å±€
# å®¡åˆ¤æ‰€æœ‰è¿åâ€œç±»å‹æ³•â€çš„è¡Œä¸ºï¼Œç¡®ä¿é€»è¾‘çš„ä¸¥è°¨ã€‚
# =======================================================================
print_chapter_header "ç¬¬äºŒç« ï¼šç±»å‹è”é‚¦è°ƒæŸ¥å±€"

# ---------------------------------------------------
# --- 2.1 Pyright ç»ˆå®¡ï¼šæœ€ä¸¥æ ¼çš„æ·±åº¦é€»è¾‘æ¨æ–­ ---
# å…ˆç”¨ Pyright åšä¸€è½®æ›´â€œæŒ‘å‰”â€çš„é™æ€åˆ†æï¼Œå°½æ—©æš´éœ²è¯­æ³•/æ¨æ–­é—®é¢˜ã€‚
# ---------------------------------------------------
print_sub_header "2.1 Pyright å®¡æŸ¥"
if check_tool "pyright" "Python é™æ€ç±»å‹æ£€æŸ¥å™¨"; then
    run_pyright "$AUDIT_TARGET"
else
    print_warning "è·³è¿‡ Pyright å®¡æŸ¥"
fi

# ---------------------------------------------------
# --- 2.2 Mypy å¤æ ¸ï¼šå¯¹ç…§canonicalç±»å‹é…ç½®åšäºŒæ¬¡ç¡®è®¤ ---
# å†ç”¨ Mypy åšä¸€è½®â€œå®˜æ–¹â€ç±»å‹å¤æ ¸ï¼Œç¡®ä¿ç¬¦åˆå¸å›½æ ‡å‡†ã€‚
# ---------------------------------------------------
print_sub_header "2.2 Mypy å¤æ ¸"
if check_tool "mypy" "Python é™æ€ç±»å‹æ£€æŸ¥å™¨"; then
    run_mypy "$AUDIT_TARGET"
else
    print_warning "è·³è¿‡ Mypy å®¡æŸ¥ã€‚"
fi

# =======================================================================
# ç¬¬ä¸‰ç« ï¼šå®‰å…¨ç½²
# å®¡åˆ¤å±å®³å¸å›½å®‰å…¨ä¸å†…éƒ¨ç§©åºçš„â€œä¸­çº§ç½ªè¡Œâ€ã€‚
# =======================================================================
print_chapter_header "ç¬¬ä¸‰ç« ï¼šå®‰å…¨ç½²"

# ---------------------------------------------------
# --- 3. Bandit å®‰å…¨ç¨½æŸ¥ ---
# åœ¨è¿›å…¥é£æ ¼/å¯ç»´æŠ¤æ€§å®¡æŸ¥å‰ï¼Œä¼˜å…ˆæ’é™¤æ˜æ˜¾çš„å®‰å…¨éšæ‚£.
# å¯¹æµ‹è¯•æ–‡ä»¶ï¼Œåªå…³å¿ƒ B101(assert) è¿™ä¸€æ¡ç½ªè¡Œï¼Œé¿å…å™ªéŸ³è¿‡å¤§ã€‚
# ---------------------------------------------------
print_sub_header "3. å®‰å…¨ç¨½æŸ¥ (Bandit)"
if check_tool "bandit" "å®‰å…¨å®¡è®¡å·¥å…· (Bandit)"; then
    if [[ "$AUDIT_TARGET" == tests* ]]; then
        run_bandit -q "$AUDIT_TARGET" -s B101
    else
        run_bandit -q "$AUDIT_TARGET"
    fi
else
    print_warning "è·³è¿‡ Bandit å®‰å…¨ç¨½æŸ¥ã€‚"
fi

# =======================================================================
# ç¬¬å››ç« ï¼šå†…æ”¿ç½²ï¼ˆä»ªå®¹ä»ªè¡¨ï¼‰
# æ£€æŸ¥ä»£ç çš„ä»ªå®¹ä»ªè¡¨å’Œé£æ ¼ã€‚
# åœ¨ç±»å‹ä¸å®‰å…¨é€šè¿‡åï¼Œå¯æŒ‰éœ€é€‰æ‹©æ£€æŸ¥â€œæ¸èŒâ€å’Œâ€œæ‡’æ”¿â€ç±»é—®é¢˜ã€‚
# =======================================================================
print_chapter_header "ç¬¬å››ç« ï¼šå†…æ”¿ç½²"

# ç¡®ä¿æ‰€æœ‰å…¬å…±æ¥å£å‡æœ‰å®Œæ•´æ–‡æ¡£
print_sub_header "4.1 æ–‡æ¡£å­—ç¬¦ä¸²æ³•åº­ (DS001)"
run_judges "DS001,DS002"

# æ£€æŸ¥ä»£ç å¤æ‚åº¦ï¼Œé˜²æ­¢è¿‡åº¦å¤æ‚åŒ–
print_sub_header "4.2 ä»£ç å¤æ‚åº¦æ³•åº­ (LL001)"
run_judges "LL001,LL002"

# ç¦æ­¢å­—ç¬¦ä¸²/æ•°å­—ç­‰ç¡¬ç¼–ç å¸¸é‡
print_sub_header "4.3 ç¡¬ç¼–ç æ³•åº­ (HC001)"
run_judges "HC001,HC004,HC005"

# æ£€æŸ¥æ˜¯å¦ç»•è¿‡RuleProvideræœºåˆ¶çš„å¸¸é‡ä½¿ç”¨
print_sub_header "4.4 å¯è°ƒå‚æ•°æ³•åº­ (PC001)"
run_judges "PC001,PC002"

# é‡‡ç”¨å‘½åç©ºé—´ç±»å‹å®šä¹‰å¸¸é‡é£æ ¼
print_sub_header "4.5 å¸¸é‡é£æ ¼æ³•åº­ (HC002)"
run_judges "HC002,HC003"

# =======================================================================
# ç¬¬äº”ç« ï¼šç¯å¢ƒç½²ï¼ˆæ¸…ç†æˆ˜åœºï¼‰
# æ¸…ç†æ‰€æœ‰è½»å¾®çš„â€œå¸‚å®¹â€é—®é¢˜ï¼Œå¹¶è¿›è¡Œæœ€ç»ˆçš„æ ¼å¼åŒ–ã€‚
# æ‰€æœ‰è¯­ä¹‰/å®‰å…¨/é£æ ¼å®¡æŸ¥é€šè¿‡åï¼Œæœ€åä¸€æ­¥ç»Ÿä¸€è‡ªåŠ¨ä¿®å¤ + æ ¼å¼åŒ–è¾“å‡ºã€‚
# =======================================================================
print_chapter_header "ç¬¬äº”ç« ï¼šç¯å¢ƒç½²"

print_sub_header "5. æ¸…ç†æˆ˜åœº (Ruff)"
if check_tool "ruff" "Python Lint & Format å·¥å…· (Ruff)"; then
    run_ruff_check "$AUDIT_TARGET" --fix
    run_ruff_format "$AUDIT_TARGET"
else
    print_warning "è·³è¿‡ Ruff å®¡æŸ¥ä¸æ ¼å¼åŒ–ã€‚"
fi

# =======================================================================
# --- ç»“æ¡ˆåˆ¤å†³ ---
# =======================================================================
print_success "ç»“æ¡ˆåˆ¤å†³ï¼šç›®æ ‡å·²è¾¾çº¯å‡€ï¼"