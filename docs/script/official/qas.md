
# å¸å›½å†›åˆ€

[Download](../../../qas.sh)

```bash
#!/bin/bash

# ==============================================================================
# ğŸ—¡ï¸ å¸å›½å†›åˆ€ V1.0
# å®¡è®¡ï¼šä½¿ç”¨é˜»æ–­æ¨¡å¼å¯¹å®¡è®¡ç›®æ ‡å±•å¼€ä¿®å¤ å‘½ä»¤ï¼š./qas.sh -s <directory>
# å‹˜å¯Ÿï¼šä½¿ç”¨ä¾¦æŸ¥æ¨¡å¼è·å¾—å…¨è²Œä»¥åˆ¶è®¢ç­–ç•¥ å‘½ä»¤ï¼š./qas.sh -s <directory> -n
# æµ‹è¯•ï¼šå¯¹å…³è”çš„æµ‹è¯•è¿›è¡Œå®¡è®¡å¹¶å•å…ƒæµ‹è¯• å‘½ä»¤ï¼š./qas.sh -s <directory> -t
# åœºæ™¯ï¼šå¯¹æŒ‡å®šç›®å½•æ‰€æœ‰æ–‡ä»¶è¿›è¡Œå…¨é¢é™æ€å®¡è®¡ï¼Œå¹¶å¯é€‰æ‰§è¡Œå…³è”æµ‹è¯•çš„å•å…ƒæµ‹è¯•ã€‚
# ==============================================================================

# ===============
# å‡†å¤‡å¼€å§‹ï¼šç¯å¢ƒé…ç½®
# ===============

# --------------------------------------------------------------
# --- 1. é›¶å®¹å¿ï¼Œå‘ç°é—®é¢˜ç«‹å³ç»ˆæ­¢ ---
# --------------------------------------------------------------
set -euo pipefail

# --------------------------------------------------------------
# --- 2. ä»¥å½“å‰ä½ç½®ä¸ºå¸å›½ä¸­å¿ƒï¼ˆå»ºè®®åœ¨ä»“åº“æ ¹æ‰§è¡Œï¼‰ ---
# --------------------------------------------------------------
export PYTHONPATH=$(pwd)

# --------------------------------------------------------------
# --- 3. PyCourt è¯­è¨€åˆ‡æ¢ï¼šé»˜è®¤ä¸ºä¸­æ–‡ï¼Œå¤–éƒ¨å¯è¦†ç›– PYCOURT_LANG=en ---
# --------------------------------------------------------------
export PYCOURT_LANG="${PYCOURT_LANG:-zh}"

# --------------------------------------------------------------
# --- 4. é€šç”¨è¾“å‡ºå‡½æ•°ï¼ˆä¸åŒ•é¦–ä¿æŒä¸€è‡´é£æ ¼ï¼‰ ---
# --------------------------------------------------------------
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'

print_chapter_header() {
    echo -e "\n${BLUE}================== $1 ==================${NC}"
}

print_sub_header() {
    echo -e "\n${YELLOW}--- $1 ---${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ---------------------------------------------------
# --- 5. å¤–éƒ¨å·¥å…·å°è£…ä¸å¯ç”¨æ€§æ£€æŸ¥---
# åªå°è£…å·¥å…·æœ¬èº«ï¼Œå…·ä½“å‚æ•°é€šè¿‡ pyproject.toml é…ç½®
# ---------------------------------------------------
run_mypy() {

    poetry run mypy "$@"
}

run_pyright() {
    poetry run pyright "$@"
}

run_bandit() {
    poetry run bandit "$@"
}

run_ruff_check() {
    poetry run ruff check "$@"
}

run_ruff_format() {
    poetry run ruff format "$@"
}

# æŠ¥å‘Šç¼ºå°‘çš„å¤–éƒ¨å·¥å…·
check_tool() {
    local cmd="$1"
    local desc="$2"
    if ! poetry run "$cmd" --version >/dev/null 2>&1; then
        print_warning "ç¼ºå°‘å¤–éƒ¨å·¥å…·: $cmd ($desc)ï¼Œå°†è·³è¿‡å¯¹åº”å®¡è®¡æ­¥éª¤ã€‚"
        return 1
    fi
    return 0
}

# --------------------------------------------------------------
# --- 6. å‚æ•°è§£æä¸å‘½ä»¤ ---
# --------------------------------------------------------------
AUDIT_DIR=""   # å®¡è®¡ç›®æ ‡ç›®å½•
AUDIT_NON_BLOCKING=0 # æ˜¯å¦å¯ç”¨éé˜»æ–­æ¨¡å¼ï¼Œé»˜è®¤ 0ï¼šé˜»æ–­æ¨¡å¼ã€‚
QAS_ENABLE_TEST_PHASE=${QAS_ENABLE_TEST_PHASE:-0} # æ˜¯å¦å¯ç”¨æµ‹è¯•é˜¶æ®µï¼Œé»˜è®¤ 0ï¼šå…³é—­ã€‚

while [[ $# -gt 0 ]]; do
  case "$1" in
    -s)
      AUDIT_DIR="$2"
      shift 2
      ;;
    -n)
      AUDIT_NON_BLOCKING=1
      shift
      ;;
    -t)
      QAS_ENABLE_TEST_PHASE=1
      shift
      ;;
    *)
      echo "âŒ æœªçŸ¥å‚æ•°: $1" >&2
      exit 1
      ;;
  esac
done

if [ -z "$AUDIT_DIR" ]; then
    echo "âŒ ç”¨æ³•é”™è¯¯: å¿…é¡»æä¾› -s <directory>" >&2
    exit 1
fi

# --------------------------------------------------------------
# --- 7. æ˜¯å¦é˜»æ–­çš„ç»Ÿä¸€å°è£… ---
# --------------------------------------------------------------
run_or_warn() {
    "$@" || {
        if [ "$AUDIT_NON_BLOCKING" = "0" ]; then
            print_error "å‘ç°é—®é¢˜ï¼Œå®¡è®¡ç»ˆæ­¢ï¼"     # åœ¨é˜»æ–­æ¨¡å¼ä¸‹ï¼Œä»»ä½•å¤±è´¥ç«‹å³é€€å‡ºï¼›
            exit 1
        else
            print_warning "å‘ç°é—®é¢˜ï¼ç»§ç»­ä¾¦æŸ¥..."  # åœ¨éé˜»æ–­æ¨¡å¼ä¸‹ï¼Œä»…æ‰“å°é—®é¢˜æŠ¥å‘Šã€‚
        fi
    }
}

# --------------------------------------------------------------
# --- 8. PyCourt ç»Ÿä¸€å®¡è®¡å…¥å£ï¼ˆScope çº§åˆ«ï¼‰
# --------------------------------------------------------------
run_judges() {
    local codes="$1"
    local target="$2"
    run_or_warn poetry run pycourt scope "$target" --select "$codes"
}

# ===============================================================================
# å®¡è®¡å†…å®¹ç¼–æ’ä¸å°è£…
# ===============================================================================
run_static_audit_on_target() {
    local audit_target="$1"
    print_chapter_header "ç¬¬ä¸€é˜¶æ®µï¼šå¸å›½å†›åˆ€ - å¯¹ã€${audit_target}ã€‘è¿›è¡Œé™æ€å®¡è®¡"

    # =======================================================================
    # ç¬¬ä¸€ç« ï¼šæ¶æ„ç”Ÿæ­»çº¿
    # å®¡åˆ¤æœ€æ ¹æœ¬çš„ã€åŠ¨æ‘‡é¡¹ç›®æ ¹åŸºçš„â€œå›å›½ç½ªâ€ã€‚
    # =======================================================================
    print_chapter_header "ç¬¬ä¸€ç« ï¼šæ¶æ„ç”Ÿæ­»çº¿"

    # ---------------------------------------------------
    # 1.1 æ¶æ„ä½ç½®ï¼šå¾ªç¯ä¾èµ– / é—¨é¢è§„èŒƒ / ä¾èµ–å€’ç½®
    # å…ˆç¡®ä¿æ–‡ä»¶ç«™åœ¨æ­£ç¡®çš„æ¶æ„ä¸–ç•Œï¼Œå¦åˆ™åç»­æ‰€æœ‰ç»“æœéƒ½å¤±å»æ„ä¹‰ã€‚
    # ---------------------------------------------------

    # ç¦æ­¢ä½¿ç”¨TYPE_CHECKINGç­‰æ‰‹æ®µå¼•å…¥å¾ªç¯ä¾èµ–
    print_sub_header "1.1.1 å¾ªç¯ä¾èµ–æ³•åº­ (TC001)"
    run_judges "TC001" "$audit_target"

    # ç¦æ­¢åœ¨é—¨é¢å±‚ä½¿ç”¨é¢†åŸŸé€»è¾‘å¹¶èšåˆå¯¼å‡º
    print_sub_header "1.1.2 é—¨é¢çºªå¾‹æ³•åº­ (RE001)"
    run_judges "RE001,RE002,RE003" "$audit_target"

    # ç¦æ­¢è¿åä¾èµ–å€’ç½®åŸåˆ™ç›´æ¥ä¾èµ–å…·ä½“å®ç°
    print_sub_header "1.1.3 ä¾èµ–å€’ç½®æ³•åº­ (DI001)"
    run_judges "DI001" "$audit_target"

    # ---------------------------------------------------
    # 1.2 äº‹åŠ¡ä¸è¾¹ç•Œï¼šUoW / è¾¹ç•Œ DTO / å‘é‡è§¦å‘åè®®
    # åœ¨æ¶æ„ä½ç½®æ­£ç¡®çš„å‰æä¸‹ï¼Œä¼˜å…ˆä¿è¯äº‹åŠ¡è¯­ä¹‰ä¸è¾¹ç•Œå¥‘çº¦çš„æ­£ç¡®ã€‚
    # ---------------------------------------------------

    # ç¦æ­¢è¿å unit of work åŸåˆ™çš„äº‹åŠ¡å¤„ç†
    print_sub_header "1.2.1 ä»“åº“äº‹åŠ¡æ³•åº­ (UW001)"
    run_judges "UW001,UW002,UW003,UW004" "$audit_target"

    # ç¦æ­¢è¿åè¾¹ç•Œ DTO è§„èŒƒçš„è·¨å±‚æ•°æ®ä¼ é€’
    print_sub_header "1.2.2 ç–†åŸŸè¾¹ç•Œæ³•åº­ (BC001)"
    run_judges "BC001" "$audit_target"

    # ç¦æ­¢è¿åå‘é‡è§¦å‘åè®®çš„äº‹ä»¶å¤„ç†
    print_sub_header "1.2.3 å‘é‡è§¦å‘æ³•åº­ (VT001)"
    run_judges "VT001" "$audit_target"

    # ---------------------------------------------------
    # 1.3 ç±»å‹ä¸é¢†åŸŸçºªå¾‹ï¼šAny/dict/cast/object æ»¥ç”¨
    # åœ¨â€œåšå¯¹äº‹ã€ç«™å¯¹å±‚â€çš„å‰æä¸‹ï¼Œæ”¶ç´§ç±»å‹ä¸é¢†åŸŸä½¿ç”¨ä¹ æƒ¯ï¼Œé˜²æ­¢ç°è‰²åœ°å¸¦ã€‚
    # ---------------------------------------------------

    # ç¦æ­¢æ»¥ç”¨é¸­å­ç±»å‹ã€Anyã€cast ç­‰ç ´åç±»å‹çº¯å‡€åº¦çš„è¡Œä¸º
    print_sub_header "1.3.1 é¸­å­ç±»å‹æ³•åº­ (AC001)"
    run_judges "AC001,AC002,AC003" "$audit_target"

    # ç¦æ­¢æ»¥ç”¨é€šç”¨å¯¹è±¡ç±»å‹ï¼ˆobjectï¼‰ç ´åé¢†åŸŸçº¯å‡€åº¦çš„è¡Œä¸º
    print_sub_header "1.3.2 é¸­å­ç±»å‹æ³•åº­ (OU001)"
    run_judges "OU001" "$audit_target"

    # ç¦æ­¢æ»¥ç”¨æ—¶é—´ç›¸å…³æ“ä½œç ´åé¢†åŸŸçº¯å‡€åº¦çš„è¡Œä¸º
    print_sub_header "1.3.3 æ—¶é—´æ¼‚ç§»æ³•åº­ (DT001)"
    run_judges "DT001" "$audit_target"

    # ç¦æ­¢è¿åæŠ€èƒ½é…ç½®è§„èŒƒçš„è¡Œä¸º
    print_sub_header "1.3.4 æŠ€èƒ½é…ç½®æ³•åº­ (SK001)"
    run_judges "SK001" "$audit_target"

    # =======================================================================
    # ç¬¬äºŒç« ï¼šç±»å‹è”é‚¦è°ƒæŸ¥å±€
    # å®¡åˆ¤æ‰€æœ‰è¿åâ€œç±»å‹æ³•â€çš„è¡Œä¸ºï¼Œç¡®ä¿é€»è¾‘çš„ä¸¥è°¨ã€‚
    # =======================================================================
    print_chapter_header "ç¬¬äºŒç« ï¼šç±»å‹è”é‚¦è°ƒæŸ¥å±€"

    # ---------------------------------------------------
    # --- 2.1 Pyright ç»ˆå®¡ï¼šæœ€ä¸¥æ ¼çš„æ·±åº¦é€»è¾‘æ¨æ–­ ---
    # å…ˆç”¨ Pyright åšä¸€è½®æ›´â€œæŒ‘å‰”â€çš„é™æ€åˆ†æï¼Œå°½æ—©æš´éœ²è¯­æ³•/æ¨æ–­é—®é¢˜ã€‚
    # ---------------------------------------------------
    print_sub_header "2.1 Pyright å®¡æŸ¥"
    if check_tool "pyright" "Python é™æ€ç±»å‹æ£€æŸ¥å™¨"; then
        run_pyright "$audit_target"
    else
        print_warning "è·³è¿‡ Pyright å®¡æŸ¥"
    fi

    # ---------------------------------------------------
    # --- 2.2 Mypy å¤æ ¸ï¼šå¯¹ç…§canonicalç±»å‹é…ç½®åšäºŒæ¬¡ç¡®è®¤ ---
    # å†ç”¨ Mypy åšä¸€è½®â€œå®˜æ–¹â€ç±»å‹å¤æ ¸ï¼Œç¡®ä¿ç¬¦åˆå¸å›½æ ‡å‡†ã€‚
    # ---------------------------------------------------
    print_sub_header "2.2 Mypy å¤æ ¸"
    if check_tool "mypy" "Python é™æ€ç±»å‹æ£€æŸ¥å™¨"; then
        run_mypy "$audit_target"
    else
        print_warning "è·³è¿‡ Mypy å®¡æŸ¥ã€‚"
    fi

    # =======================================================================
    # ç¬¬ä¸‰ç« ï¼šå®‰å…¨ç½²
    # å®¡åˆ¤å±å®³å¸å›½å®‰å…¨ä¸å†…éƒ¨ç§©åºçš„â€œä¸­çº§ç½ªè¡Œâ€ã€‚
    # =======================================================================
    print_chapter_header "ç¬¬ä¸‰ç« ï¼šå®‰å…¨ç½²"

    # ---------------------------------------------------
    # --- 3. Bandit å®‰å…¨ç¨½æŸ¥ ---
    # åœ¨è¿›å…¥é£æ ¼/å¯ç»´æŠ¤æ€§å®¡æŸ¥å‰ï¼Œä¼˜å…ˆæ’é™¤æ˜æ˜¾çš„å®‰å…¨éšæ‚£.
    # å¯¹æµ‹è¯•æ–‡ä»¶ï¼Œåªå…³å¿ƒ B101(assert) è¿™ä¸€æ¡ç½ªè¡Œï¼Œé¿å…å™ªéŸ³è¿‡å¤§ã€‚
    # ---------------------------------------------------
    print_sub_header "3. å®‰å…¨ç¨½æŸ¥ (Bandit)"
    if check_tool "bandit" "å®‰å…¨å®¡è®¡å·¥å…· (Bandit)"; then
        # ç›®å½•ç›®æ ‡ï¼šé€’å½’æ‰«æ (-r)ï¼›å•æ–‡ä»¶ï¼šç›´æ¥æ‰«æã€‚
        if [ -d "$audit_target" ]; then
            if [[ "$audit_target" == tests* ]]; then
                run_bandit -q -r "$audit_target" -s B101
            else
                run_bandit -q -r "$audit_target"
            fi
        else
            if [[ "$audit_target" == tests* ]]; then
                run_bandit -q "$audit_target" -s B101
            else
                run_bandit -q "$audit_target"
            fi
        fi
    else
        print_warning "è·³è¿‡ Bandit å®‰å…¨ç¨½æŸ¥ã€‚"
    fi

    # =======================================================================
    # ç¬¬å››ç« ï¼šå†…æ”¿ç½²ï¼ˆä»ªå®¹ä»ªè¡¨ï¼‰
    # æ£€æŸ¥ä»£ç çš„ä»ªå®¹ä»ªè¡¨å’Œé£æ ¼ã€‚
    # åœ¨ç±»å‹ä¸å®‰å…¨é€šè¿‡åï¼Œå¯æŒ‰éœ€é€‰æ‹©æ£€æŸ¥â€œæ¸èŒâ€å’Œâ€œæ‡’æ”¿â€ç±»é—®é¢˜ã€‚
    # =======================================================================
    print_chapter_header "ç¬¬å››ç« ï¼šå†…æ”¿ç½²"

    # ç¡®ä¿æ‰€æœ‰å…¬å…±æ¥å£å‡æœ‰å®Œæ•´æ–‡æ¡£
    print_sub_header "4.1 æ–‡æ¡£å­—ç¬¦ä¸²æ³•åº­ (DS001)"
    run_judges "DS001,DS002" "$audit_target"

    # æ£€æŸ¥ä»£ç å¤æ‚åº¦ï¼Œé˜²æ­¢è¿‡åº¦å¤æ‚åŒ–
    print_sub_header "4.2 ä»£ç å¤æ‚åº¦æ³•åº­ (LL001)"
    run_judges "LL001,LL002" "$audit_target"

    # ç¦æ­¢å­—ç¬¦ä¸²/æ•°å­—ç­‰ç¡¬ç¼–ç å¸¸é‡
    print_sub_header "4.3 ç¡¬ç¼–ç æ³•åº­ (HC001)"
    run_judges "HC001,HC004,HC005" "$audit_target"

    # æ£€æŸ¥æ˜¯å¦ç»•è¿‡RuleProvideræœºåˆ¶çš„å¸¸é‡ä½¿ç”¨
    print_sub_header "4.4 å¯è°ƒå‚æ•°æ³•åº­ (PC001)"
    run_judges "PC001,PC002" "$audit_target"

    # é‡‡ç”¨å‘½åç©ºé—´ç±»å‹å®šä¹‰å¸¸é‡é£æ ¼
    print_sub_header "4.5 å¸¸é‡é£æ ¼æ³•åº­ (HC002)"
    run_judges "HC002,HC003" "$audit_target"

    # =======================================================================
    # ç¬¬äº”ç« ï¼šç¯å¢ƒç½²ï¼ˆæ¸…ç†æˆ˜åœºï¼‰
    # æ¸…ç†æ‰€æœ‰è½»å¾®çš„â€œå¸‚å®¹â€é—®é¢˜ï¼Œå¹¶è¿›è¡Œæœ€ç»ˆçš„æ ¼å¼åŒ–ã€‚
    # æ‰€æœ‰è¯­ä¹‰/å®‰å…¨/é£æ ¼å®¡æŸ¥é€šè¿‡åï¼Œæœ€åä¸€æ­¥ç»Ÿä¸€è‡ªåŠ¨ä¿®å¤ + æ ¼å¼åŒ–è¾“å‡ºã€‚
    # =======================================================================
    print_chapter_header "ç¬¬äº”ç« ï¼šç¯å¢ƒç½²"

    print_sub_header "5. æ¸…ç†æˆ˜åœº (Ruff)"
    if check_tool "ruff" "Python Lint & Format å·¥å…· (Ruff)"; then
        run_ruff_check "$audit_target" --fix
        run_ruff_format "$audit_target"
    else
        print_warning "è·³è¿‡ Ruff å®¡æŸ¥ä¸æ ¼å¼åŒ–ã€‚"
    fi
}


# ==============================================================================
# å†›åˆ€ä»»åŠ¡ç¼–æ’
# ==============================================================================

# ------------------------------------------------------------------------------
# --- ç¬¬ä¸€é˜¶æ®µï¼šå¸å›½å†›åˆ€ - é™æ€å®¡è®¡ ---
# ------------------------------------------------------------------------------
print_chapter_header "ğŸ—¡ï¸ ç¬¬ä¸€é˜¶æ®µï¼šå¸å›½å†›åˆ€ - å¯¹ã€${AUDIT_DIR}ã€‘è¿›è¡Œé™æ€å®¡è®¡"
print_sub_header "å®¡è®¡ç›®æ ‡: $AUDIT_DIR"
if [ "$AUDIT_NON_BLOCKING" = "1" ]; then
    print_warning "æ¨¡å¼: éé˜»æ–­å¼ä¾¦å¯Ÿ"
fi

run_static_audit_on_target "$AUDIT_DIR"
print_success "âœ… ç›®æ ‡æˆ˜åŒºã€${AUDIT_DIR}ã€‘é™æ€å®¡è®¡é€šè¿‡ï¼"

# ------------------------------------------------------------------------------
# --- ç¬¬äºŒé˜¶æ®µï¼šå¸å›½å†›åˆ€ - å›½é˜²æ¼”ä¹ ï¼ˆå¯é€‰ï¼Œé€šè¿‡ -t æ§åˆ¶ï¼‰ ---
# ------------------------------------------------------------------------------
if [ "$QAS_ENABLE_TEST_PHASE" -eq 1 ]; then
  print_warning "æ¼”ä¹ : å¯ç”¨å•å…ƒæµ‹è¯•"
  print_chapter_header "ç¬¬äºŒé˜¶æ®µï¼šå¸å›½å›½é˜²æ¼”ä¹ "

  # ç‰¹æ®Šæƒ…å†µï¼šå½“å®¡è®¡ç›®æ ‡æœ¬èº«å°±æ˜¯ tests* æ—¶ï¼Œè§†ä¸ºâ€œç›´æ¥å®¡è®¡æµ‹è¯•æˆ˜åŒºâ€ï¼Œ
  # ä¸å†é¢å¤–æ‰§è¡Œ TP å®¡æŸ¥ä¸ pytest æ¼”ä¹ ï¼Œé¿å…é‡å¤ä¸æ­§ä¹‰ã€‚
  if [[ "$AUDIT_DIR" == tests* ]]; then
      print_warning "å®¡è®¡ç›®æ ‡ä¸ºæµ‹è¯•æœ¬èº«ï¼Œè·³è¿‡å›½é˜²æ¼”ä¹ ã€‚"
  elif [ ! -d "tests" ]; then
      print_warning "æœªå‘ç° tests ç›®å½•ï¼Œè·³è¿‡æ¼”ä¹ ã€‚"
  else
      # 1. æ™ºèƒ½å¯»æ‰¾ä¸å®¡è®¡ç›®æ ‡å¯¹åº”çš„æµ‹è¯•é•œåƒç›®å½•
      #    ä¼˜å…ˆå°è¯•ä¸¥æ ¼é•œåƒï¼šAUDIT_DIR=foo/bar â†’ tests/foo/bar
      #    å…¶æ¬¡å°è¯•é¡¶å±‚é•œåƒï¼šAUDIT_DIR=foo/... â†’ tests/foo
      #    è‹¥ä»æœªå‘½ä¸­ï¼Œåˆ™é€€åŒ–ä¸ºå…¨å±€ tests/ã€‚
      RELATED_TEST_DIR=""

      # ä¸¥æ ¼é•œåƒ
      candidate="tests/${AUDIT_DIR}"
      if [ -d "$candidate" ]; then
          RELATED_TEST_DIR="$candidate"
      else
          # é¡¶å±‚ç›®å½•é•œåƒ
          top_level="${AUDIT_DIR%%/*}"
          candidate="tests/${top_level}"
          if [ -d "$candidate" ]; then
              RELATED_TEST_DIR="$candidate"
          elif [ -d "tests" ]; then
              # é€€åŒ–ä¸ºå…¨å±€ tests/
              RELATED_TEST_DIR="tests"
          fi
      fi

      if [ -z "$RELATED_TEST_DIR" ]; then
          print_warning "æœªæ‰¾åˆ°ä¸ $AUDIT_DIR åŒ¹é…çš„é•œåƒæµ‹è¯•ç›®å½•ï¼Œè·³è¿‡å›½é˜²æ¼”ä¹ ã€‚"
      else
          print_sub_header "æµ‹è¯•æˆ˜åŒºé•œåƒ: $RELATED_TEST_DIR"

          # 2. å•å…ƒæµ‹è¯•å†›è§„å®¡æŸ¥ï¼ˆTP ç³»åˆ—ï¼Œä»…é’ˆå¯¹åŒ¹é…åˆ°çš„æµ‹è¯•æˆ˜åŒºï¼‰
          print_sub_header "2.1 å¸å›½æˆå«å…µå›¢å†›è§„å®¡æŸ¥ (TP ç³»åˆ—)"
          run_or_warn poetry run python pycourt/judge.py "$RELATED_TEST_DIR" --select TP001,TP002,TP003
          print_success "âœ… æµ‹è¯•æˆ˜åŒºã€${RELATED_TEST_DIR}ã€‘å•å…ƒæµ‹è¯•çº¯å‡€åº¦é€šè¿‡"

          # 3. å¯¹æµ‹è¯•æˆ˜åŒºé™æ€å®¡è®¡
          print_sub_header "2.2 æµ‹è¯•æˆ˜åŒºé™æ€å®¡è®¡"
          run_static_audit_on_target "$RELATED_TEST_DIR"

          # 4. æ‰§è¡Œå•å…ƒæµ‹è¯•æ¼”ä¹ 
          print_sub_header "2.3 å•å…ƒæµ‹è¯•æ¼”ä¹  (pytest -m unit)"
          print_sub_header "æ¼”ä¹ é¶åœº: $RELATED_TEST_DIR"
          print_sub_header "æ¼”ä¹ å…µç§: çº¯ç²¹æ­¥å…µ (æ ‡è®°: 'unit')"

          COV_ARGS=(--cov="$AUDIT_DIR" --cov-report=term-missing --cov-fail-under=0)

          set +e
          poetry run pytest -m "unit" "${COV_ARGS[@]}" "$RELATED_TEST_DIR"
          status=$?
          set -e

          if [ "$status" -ne 0 ] && [ "$status" -ne 5 ]; then # 5 = no tests collected
              run_or_warn false
          fi
      fi
  fi

  print_success "ç›®æ ‡æˆ˜åŒºã€${AUDIT_DIR}ã€‘å•å…ƒæµ‹è¯•å®Œæˆï¼"
fi

# ==============================================================================
# æœ€ç»ˆè£å†³
# ==============================================================================
if [ "$AUDIT_NON_BLOCKING" = "1" ]; then
  print_chapter_header "ğŸ›ï¸ å¸å›½å†›åˆ€å®Œæˆä¾¦å¯Ÿ - æˆ˜åŒºæƒ…æŠ¥å·²è¾¾ï¼"
else
  print_chapter_header "ğŸ›ï¸ å¸å›½å†›åˆ€å®¡è®¡å®Œæˆ - æˆ˜åŒºå·²è¾¾çº¯å‡€ï¼"
fi
```

---

[Download](../../../qas.sh)

---