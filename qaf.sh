#!/bin/bash

# ==============================================================================
# ğŸ—¡ï¸ å¸å›½ç‰¹æˆ˜åŒ•é¦– V4.0 - æ·¬ç«é‡é“¸
# å¯¹å•ä¸€æ–‡ä»¶è¿›è¡Œå®¡è®¡
# å¿…é¡»ç¡®ä¿è¯¥æ–‡ä»¶æ‰€æœ‰æŠ¥é”™æ¸…é›¶ï¼Œå°½ç®¡å½“å‰ä»»åŠ¡ä¸åŒ…å«è¿™äº›æŠ¥é”™çš„ä¿®å¤ã€‚
# ==============================================================================

# --- å¸å›½å†›æ³•ï¼šé›¶å®¹å¿ï¼Œç«‹å³ç»ˆæ­¢ ---
set -euo pipefail

# --- æ ¸å¿ƒï¼šä»¥å½“å‰ä½ç½®ä¸ºå¸å›½ä¸­å¿ƒ ---
export PYTHONPATH=$(pwd)

# --- PyCourt è¯­è¨€åˆ‡æ¢ï¼šé»˜è®¤ä¸ºä¸­æ–‡ï¼Œå¤–éƒ¨å¯è¦†ç›– PYCOURT_LANG=en ---
export PYCOURT_LANG="${PYCOURT_LANG:-zh}"

# --- å‚æ•°è§£æä¸éªŒè¯ ---
if [ -z "$1" ]; then
    echo "âŒ é”™è¯¯ï¼šå¿…é¡»æä¾›ä¸€ä¸ªå®¡åˆ¤ç›®æ ‡ (æ–‡ä»¶è·¯å¾„)" >&2
    echo "ç”¨æ³•: ./qaf.sh <path/to/file>" >&2
    exit 1
fi

AUDIT_TARGET="$1"

# åŒ•é¦–çš„æ ¸å¿ƒä½¿å‘½æ˜¯â€œå•æ–‡ä»¶â€ï¼Œæˆ‘ä»¬åœ¨æ­¤å¼ºåˆ¶æ‰§è¡Œ
if [ ! -f "$AUDIT_TARGET" ]; then
    echo "âŒ é”™è¯¯ï¼šå¸å›½ç‰¹æˆ˜åŒ•é¦–çš„å®¡åˆ¤ç›®æ ‡å¿…é¡»æ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚" >&2
    exit 1
fi

# --- ç»Ÿä¸€åŠ è½½å¸å›½æ­¦å¤‡åº“ï¼ˆé¢œè‰²ä¸æ‰“å°ã€mypyåŠ é€Ÿï¼‰ - å†…è”å®ç° ---
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'

print_chapter_header() {
    echo -e "\n${BLUE}================== $1 ==================${NC}"
}

print_sub_header() {
    echo -e "\n${YELLOW}--- $1 ---${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

run_mypy_judgement() {
    poetry run mypy "$@"
}

check_tool() {
    local cmd="$1"
    local desc="$2"
    if ! command -v "$cmd" >/dev/null 2>&1; then
        print_warning "ç¼ºå°‘å¤–éƒ¨å·¥å…·: $cmd ($desc)ï¼Œå°†è·³è¿‡å¯¹åº”å®¡è®¡æ­¥éª¤ã€‚"
        return 1
    fi
    return 0
}

run_judges() {
    # ç»Ÿä¸€å…¥å£ï¼šå¯¹å½“å‰å®¡è®¡ç›®æ ‡è¿è¡ŒæŒ‡å®šæ³•æ¡ç»„åˆï¼ˆé€—å·åˆ†éš”çš„ CODE åˆ—è¡¨ï¼‰ã€‚
    local codes="$1"
    poetry run python pycourt/judge.py "$AUDIT_TARGET" --select "$codes"
}

print_chapter_header "ğŸ—¡ï¸ å¸å›½ç‰¹æˆ˜åŒ•é¦– V4.1 - ä½œæˆ˜å‡†å¤‡"
print_sub_header "å®¡è®¡ç›®æ ‡: $AUDIT_TARGET"

# ==============================================================================
# ç¬¬ä¸€ç« ï¼šã€é“ã€‘å¸å›½å®ªæ³•æ³•é™¢ (The Constitutional Court)
# å®¡åˆ¤æœ€æ ¹æœ¬çš„ã€åŠ¨æ‘‡å¸å›½æ ¹åŸºçš„â€œå›å›½ç½ªâ€ã€‚
# æ‰§æ³•é¡ºåºéµå¾ªâ€œå…ˆæ¶æ„ç”Ÿæ­»çº¿ â†’ å†äº‹åŠ¡ä¸è¾¹ç•Œ â†’ å†ç±»å‹çºªå¾‹â€çš„æ¼æ–—æ¨¡å‹ã€‚
# ==============================================================================
print_chapter_header "ç¬¬ä¸€ç« ï¼šã€é“ã€‘å¸å›½æœ€é«˜æ³•é™¢"

# ------------------------------------------------------------------------------
# 1.1 æ¶æ„ç”Ÿæ­»çº¿ï¼šTYPE_CHECKING / é—¨é¢çºªå¾‹ / ä¾èµ–å€’ç½®
# å…ˆç¡®ä¿æ–‡ä»¶ç«™åœ¨æ­£ç¡®çš„æ¶æ„ä¸–ç•Œï¼Œå¦åˆ™åç»­æ‰€æœ‰ç»“æœéƒ½å¤±å»æ„ä¹‰ã€‚
# ------------------------------------------------------------------------------
print_sub_header "1.1 å¾ªç¯ä¾èµ–æ³•åº­ (TC001)"
run_judges "TC001"

print_sub_header "1.2 é—¨é¢çºªå¾‹æ³•åº­ (RE001, RE002, RE003)"
run_judges "RE001,RE002,RE003"

print_sub_header "1.3 ä¾èµ–å€’ç½®æ³•åº­ (DI001)"
run_judges "DI001"

# ------------------------------------------------------------------------------
# 1.2 äº‹åŠ¡ä¸è¾¹ç•Œå¥‘çº¦ï¼šUoW / è¾¹ç•Œ DTO / å‘é‡è§¦å‘åè®®
# åœ¨æ¶æ„ä½ç½®æ­£ç¡®çš„å‰æä¸‹ï¼Œä¼˜å…ˆä¿è¯äº‹åŠ¡è¯­ä¹‰ä¸è¾¹ç•Œå¥‘çº¦ä¸è¢«ç ´åã€‚
# ------------------------------------------------------------------------------
print_sub_header "1.4 ä»“åº“äº‹åŠ¡è§„èŒƒå®¡æŸ¥ (UW001, UW002, UW003, UW004)"
run_judges "UW001,UW002,UW003,UW004"

print_sub_header "1.5 ç–†åŸŸè¾¹ç•Œæ³•åº­ (BC001)"
run_judges "BC001"

print_sub_header "1.6 Vector Trigger å¥‘çº¦å®¡æŸ¥ (VT001)"
run_judges "VT001"

# ------------------------------------------------------------------------------
# 1.3 ç±»å‹ä¸é¢†åŸŸçºªå¾‹ï¼šAny/dict/cast/object / æ—¶é—´æ¥æº / Skill ä½¿ç”¨
# åœ¨â€œåšå¯¹äº‹ã€ç«™å¯¹å±‚â€çš„å‰æä¸‹ï¼Œæ”¶ç´§ç±»å‹ä¸é¢†åŸŸä½¿ç”¨ä¹ æƒ¯ï¼Œé˜²æ­¢ç°è‰²åœ°å¸¦ã€‚
# ------------------------------------------------------------------------------
print_sub_header "1.7 ç±»å‹å·æ‡’æ³•åº­ (AC001, AC002, AC003, OU001)"
run_judges "AC001,AC002,AC003,OU001"

print_sub_header "1.8 æ—¶é—´æ³•å®˜ (DT001)"
run_judges "DT001"

print_sub_header "1.9 æŠ€èƒ½ä½¿ç”¨æ³•åº­ (SK001)"
run_judges "SK001"

# ==============================================================================
# ç¬¬äºŒç« ï¼šã€æ³•ã€‘è”é‚¦ç±»å‹è°ƒæŸ¥å±€ (The Bureau of Type Investigation)
# å®¡åˆ¤æ‰€æœ‰è¿åå¸å›½â€œç±»å‹æ³•â€çš„è¡Œä¸ºï¼Œç¡®ä¿é€»è¾‘çš„ä¸¥è°¨ã€‚
# ==============================================================================
print_chapter_header "ç¬¬äºŒç« ï¼šã€æ³•ã€‘è”é‚¦ç±»å‹è°ƒæŸ¥å±€"

# --- 2.1 Pyright ç»ˆå®¡ï¼šæœ€ä¸¥æ ¼çš„æ·±åº¦é€»è¾‘æ¨æ–­ ---
# å…ˆç”¨ Pyright åšä¸€è½®æ›´â€œæŒ‘å‰”â€çš„é™æ€åˆ†æï¼Œå°½æ—©æš´éœ²è¯­æ³•/æ¨æ–­é—®é¢˜ã€‚
print_sub_header "2.1 Pyright ç»ˆå®¡"
if check_tool "pyright" "Python é™æ€ç±»å‹æ£€æŸ¥å™¨"; then
    poetry run pyright "$AUDIT_TARGET"
else
    print_warning "è·³è¿‡ Pyright å®¡æŸ¥ã€‚"
fi

# --- 2.2 Mypy å¤æ ¸ï¼šå¯¹ç…§å¸å›½ canonical ç±»å‹é…ç½®åšäºŒæ¬¡ç¡®è®¤ ---
print_sub_header "2.2 Mypy å¤æ ¸"
if check_tool "mypy" "Python é™æ€ç±»å‹æ£€æŸ¥å™¨ (Mypy)"; then
    run_mypy_judgement "$AUDIT_TARGET"
else
    print_warning "è·³è¿‡ Mypy å®¡æŸ¥ã€‚"
fi

# ==============================================================================
# ç¬¬ä¸‰ç« ï¼šã€æœ¯ã€‘å¸å›½å®‰å…¨ä¸å†…æ”¿ç½² (The Agency of Security & Internal Affairs)
# å®¡åˆ¤å±å®³å¸å›½å®‰å…¨ä¸å†…éƒ¨ç§©åºçš„â€œä¸­çº§ç½ªè¡Œâ€ã€‚
# ==============================================================================
print_chapter_header "ç¬¬ä¸‰ç« ï¼šã€æœ¯ã€‘å¸å›½å®‰å…¨ä¸å†…æ”¿ç½²"

# --- 3.1 Bandit å®‰å…¨ç¨½æŸ¥ ---
# åœ¨è¿›å…¥é£æ ¼/å¯ç»´æŠ¤æ€§å®¡æŸ¥å‰ï¼Œä¼˜å…ˆæ’é™¤æ˜æ˜¾çš„å®‰å…¨éšæ‚£ã€‚
print_sub_header "3.1 å®‰å…¨ç¨½æŸ¥ (Bandit)"
# å¯¹æµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬åªå…³å¿ƒ B101(assert) è¿™ä¸€æ¡ç½ªè¡Œï¼Œé¿å…å™ªéŸ³è¿‡å¤§ã€‚
if check_tool "bandit" "å®‰å…¨å®¡è®¡å·¥å…· (Bandit)"; then
    if [[ "$AUDIT_TARGET" == tests* ]]; then
        BANDIT_CMD=(bandit -q "$AUDIT_TARGET" -s B101)
    else
        BANDIT_CMD=(bandit -q "$AUDIT_TARGET")
    fi
    poetry run "${BANDIT_CMD[@]}"
else
    print_warning "è·³è¿‡ Bandit å®‰å…¨ç¨½æŸ¥ã€‚"
fi

# --- 3.2 æœ€é«˜æ³•é™¢æ™®é€šåº­ï¼šæ–‡æ¡£ / å¤æ‚åº¦ / ç¡¬ç¼–ç  / è¿è¥å‚æ•° ---
# åœ¨ç±»å‹ä¸å®‰å…¨é€šè¿‡åï¼Œç»Ÿä¸€æ£€æŸ¥â€œæ¸èŒâ€å’Œâ€œæ‡’æ”¿â€ç±»é—®é¢˜ã€‚
print_sub_header "3.2 æœ€é«˜æ³•é™¢æ™®é€šåº­ (DS / LL / HC / PC)"
run_judges "DS001,DS002,LL001,LL002,HC001,HC002,HC003,HC004,HC005,PC001,PC002"


# ==============================================================================
# ç¬¬å››ç« ï¼šã€å™¨ã€‘åœ°æ–¹æ²»å®‰ä¸ç¯å¢ƒç½² (The Agency of Protocol & Environment)
# æ¸…ç†æ‰€æœ‰è½»å¾®çš„â€œå¸‚å®¹â€é—®é¢˜ï¼Œå¹¶è¿›è¡Œæœ€ç»ˆçš„æ ¼å¼åŒ–ã€‚
# ==============================================================================
print_chapter_header "ç¬¬å››ç« ï¼šã€å™¨ã€‘ä»ªå®¹ä»ªè¡¨å®¡æŸ¥"

# --- 4.1 Ruff æˆ˜åœºæ¸…ç† ---
# æ‰€æœ‰è¯­ä¹‰/å®‰å…¨/é£æ ¼å®¡æŸ¥é€šè¿‡åï¼Œæœ€åä¸€æ­¥ç»Ÿä¸€è‡ªåŠ¨ä¿®å¤ + æ ¼å¼åŒ–è¾“å‡ºã€‚
print_sub_header "4.1 æœ€ç»ˆç»“æ¡ˆ (Ruff)"
if check_tool "ruff" "Python Lint & Format å·¥å…· (Ruff)"; then
    poetry run ruff check "$AUDIT_TARGET" --fix
    poetry run ruff format "$AUDIT_TARGET"
else
    print_warning "è·³è¿‡ Ruff å®¡æŸ¥ä¸æ ¼å¼åŒ–ã€‚"
fi

print_success "æœ€ç»ˆåˆ¤å†³ï¼šç›®æ ‡å·²è¾¾çº¯å‡€ï¼"